(function(){"use strict";var e={4731:function(e,t,s){var i=s(5130),n=s(6768),r=s(4232);const o={class:"chat-container"},a={class:"chat-header"},c={class:"character-select"},h={key:0,class:"character-list"},l=["onClick"],g={class:"chat-messages"},u={class:"chat-input"},p=["disabled"];function d(e,t,s,d,m,f){const w=(0,n.g2)("ChatMessage");return(0,n.uX)(),(0,n.CE)("div",o,[(0,n.Lk)("div",a,[t[6]||(t[6]=(0,n.Lk)("h2",null,"WeChat-like Chat",-1)),(0,n.Lk)("div",c,[(0,n.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>f.toggleCharacterMenu&&f.toggleCharacterMenu(...e)),class:"menu-button"},[(0,n.eW)((0,r.v_)(m.selectedCharacter?m.selectedCharacter.split(".")[0]:"选择角色")+" ",1),t[5]||(t[5]=(0,n.Lk)("span",{class:"dropdown-arrow"},"▼",-1))]),m.showCharacterMenu?((0,n.uX)(),(0,n.CE)("ul",h,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(m.characterFiles,(e=>((0,n.uX)(),(0,n.CE)("li",{key:e,onClick:t=>f.selectCharacter(e)},(0,r.v_)(e.split(".")[0]),9,l)))),128))])):(0,n.Q3)("",!0)])]),(0,n.Lk)("div",g,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(m.messages,((e,t)=>((0,n.uX)(),(0,n.Wv)(w,{key:t,message:e},null,8,["message"])))),128))]),(0,n.Lk)("div",u,[(0,n.Lk)("button",{onClick:t[1]||(t[1]=(...e)=>f.toggleListening&&f.toggleListening(...e)),disabled:m.isWaitingForResponse,class:"mic-button"},(0,r.v_)(m.isListening?"停止":"🎤"),9,p),(0,n.bo)((0,n.Lk)("input",{type:"text","onUpdate:modelValue":t[2]||(t[2]=e=>m.newMessage=e),onKeydown:t[3]||(t[3]=(0,i.jR)(((...e)=>f.sendMessage&&f.sendMessage(...e)),["enter"])),placeholder:"Type your message..."},null,544),[[i.Jo,m.newMessage]]),(0,n.Lk)("button",{onClick:t[4]||(t[4]=(...e)=>f.sendMessage&&f.sendMessage(...e)),class:"send-button"},"Send")])])}s(4114);const m={class:"message-content"};function f(e,t,s,i,o,a){return(0,n.uX)(),(0,n.CE)("div",{class:(0,r.C4)(["message",a.messageClass])},[(0,n.Lk)("div",m,(0,r.v_)(s.message.text),1)],2)}var w={props:{message:{type:Object,required:!0}},computed:{messageClass(){return{"user-message":"user"===this.message.type,"ai-message":"ai"===this.message.type}}}},C=s(1241);const v=(0,C.A)(w,[["render",f],["__scopeId","data-v-86c86a34"]]);var M=v,k={components:{ChatMessage:M},data(){return{messages:[],newMessage:"",recognition:null,isListening:!1,characterFiles:[],selectedCharacter:null,showCharacterMenu:!1,firstMessage:!0,isWaitingForResponse:!1,lastSpeechTimestamp:0,silenceTimer:null,interimTranscript:""}},mounted(){this.fetchCharacterFiles(),"SpeechRecognition"in window||"webkitSpeechRecognition"in window?(this.recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition),this.recognition.lang="zh-CN",this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.onresult=e=>{if(this.isWaitingForResponse)return;let t="";this.interimTranscript="";for(let s=e.resultIndex;s<e.results.length;++s)e.results[s].isFinal?(t+=e.results[s][0].transcript,this.lastSpeechTimestamp=Date.now()):this.interimTranscript+=e.results[s][0].transcript;t?(this.newMessage=t,this.resetSilenceTimer()):this.interimTranscript&&(this.newMessage=this.interimTranscript)},this.recognition.onend=()=>{this.isListening&&this.recognition.start()},this.recognition.onerror=e=>{console.error("Speech recognition error:",e.error),this.isListening=!1,this.isWaitingForResponse=!1,"no-speech"===e.error?alert("没有检测到声音，请说话。"):"audio-capture"===e.error?alert("无法访问麦克风，请检查麦克风是否已连接。"):"not-allowed"===e.error?alert("未授权麦克风访问，请在浏览器设置中允许此网站使用麦克风。"):alert("语音识别出错: "+e.error)}):alert("您的浏览器不支持语音识别。")},methods:{fetchCharacterFiles(){fetch("http://127.0.0.1:5000/list_characters").then((e=>e.json())).then((e=>{e.characters&&(this.characterFiles=e.characters)})).catch((e=>console.error("Error fetching characters:",e)))},selectCharacter(e){this.selectedCharacter=e,this.showCharacterMenu=!1,this.firstMessage=!0},toggleCharacterMenu(){this.showCharacterMenu=!this.showCharacterMenu},async sendMessage(){if(!this.newMessage.trim())return;const e={message:this.newMessage,character:this.selectedCharacter,first_message:this.firstMessage};this.messages.push({text:this.newMessage,type:"user"}),this.newMessage="",this.interimTranscript="",this.isWaitingForResponse=!0;const t=this.messages.push({text:"",type:"ai",loading:!0})-1;try{const s=await fetch("http://127.0.0.1:5000/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),i=await s.json();i.response?(this.messages[t].text=i.response,this.messages[t].loading=!1):(this.messages[t].text="Error: "+(i.error||"Unknown error"),this.messages[t].loading=!1),this.$nextTick((()=>this.scrollToBottom())),this.firstMessage=!1}catch(s){console.error("Error:",s),this.messages.push({text:"Error: Could not connect to the server.",type:"ai",loading:!1}),this.$nextTick((()=>this.scrollToBottom()))}finally{this.isWaitingForResponse=!1,this.resetSilenceTimer()}},toggleListening(){this.isListening?this.stopListening():this.startListening()},startListening(){this.recognition&&(this.isListening=!0,this.recognition.start(),this.resetSilenceTimer())},stopListening(){this.isListening=!1,this.recognition.stop(),clearTimeout(this.silenceTimer)},resetSilenceTimer(){clearTimeout(this.silenceTimer),this.silenceTimer=setTimeout((()=>{this.newMessage.trim()&&!this.isWaitingForResponse&&(this.sendMessage(),this.newMessage="")}),2e3)},scrollToBottom(){const e=this.$el.querySelector(".chat-messages");e&&(e.scrollTop=e.scrollHeight)}}};const T=(0,C.A)(k,[["render",d],["__scopeId","data-v-ed892c18"]]);var y=T;(0,i.Ef)(y).mount("#app")}},t={};function s(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={exports:{}};return e[i].call(r.exports,r,r.exports,s),r.exports}s.m=e,function(){var e=[];s.O=function(t,i,n,r){if(!i){var o=1/0;for(l=0;l<e.length;l++){i=e[l][0],n=e[l][1],r=e[l][2];for(var a=!0,c=0;c<i.length;c++)(!1&r||o>=r)&&Object.keys(s.O).every((function(e){return s.O[e](i[c])}))?i.splice(c--,1):(a=!1,r<o&&(o=r));if(a){e.splice(l--,1);var h=n();void 0!==h&&(t=h)}}return t}r=r||0;for(var l=e.length;l>0&&e[l-1][2]>r;l--)e[l]=e[l-1];e[l]=[i,n,r]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={524:0};s.O.j=function(t){return 0===e[t]};var t=function(t,i){var n,r,o=i[0],a=i[1],c=i[2],h=0;if(o.some((function(t){return 0!==e[t]}))){for(n in a)s.o(a,n)&&(s.m[n]=a[n]);if(c)var l=c(s)}for(t&&t(i);h<o.length;h++)r=o[h],s.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return s.O(l)},i=self["webpackChunkfrontend"]=self["webpackChunkfrontend"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var i=s.O(void 0,[504],(function(){return s(4731)}));i=s.O(i)})();
//# sourceMappingURL=app.7ec4d9a3.js.map